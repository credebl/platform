#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸ”’ Checking commit signatures..."

# Get commits being pushed
while read local_ref local_sha remote_ref remote_sha; do
  # Range of commits depending on whether remote branch exists
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    range="$local_sha"
  else
    range="$remote_sha..$local_sha"
  fi

  # Verify each commit in range
  for commit in $(git rev-list $range); do
    sig_status=$(git log --format='%G?' -n 1 $commit)

    if [ "$sig_status" != "G" ]; then
      echo "Commit $commit is not verified!"
      echo "Please sign commits with -S or configure SSH signing"
      exit 1
    fi
  done
done

echo "All commits are signed and verified"
